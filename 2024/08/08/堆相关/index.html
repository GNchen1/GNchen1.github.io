<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>堆相关 | Chen's Blog</title><meta name="author" content="GNchen1"><meta name="copyright" content="GNchen1"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="仅供个人学习参考">
<meta property="og:type" content="article">
<meta property="og:title" content="堆相关">
<meta property="og:url" content="http://example.com/2024/08/08/%E5%A0%86%E7%9B%B8%E5%85%B3/index.html">
<meta property="og:site_name" content="Chen&#39;s Blog">
<meta property="og:description" content="仅供个人学习参考">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/C17zz/Pages/main/Img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20240709170801.jpg">
<meta property="article:published_time" content="2024-08-08T08:54:40.000Z">
<meta property="article:modified_time" content="2024-08-08T08:54:21.001Z">
<meta property="article:author" content="GNchen1">
<meta property="article:tag" content="堆">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/C17zz/Pages/main/Img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20240709170801.jpg"><link rel="shortcut icon" href="https://raw.githubusercontent.com/C17zz/Pages/main/Img/%E8%8A%99%E8%8E%89%E8%8E%B2.jpg"><link rel="canonical" href="http://example.com/2024/08/08/%E5%A0%86%E7%9B%B8%E5%85%B3/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '堆相关',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-08-08 16:54:21'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body><script>window.paceOptions = {
  restartOnPushState: false
}

document.addEventListener('pjax:send', () => {
  Pace.restart()
})
</script><link rel="stylesheet" href="https://raw.githubusercontent.com/C17zz/Pages/main/Img/loading-bar.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://raw.githubusercontent.com/C17zz/Pages/main/Img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20240709170756.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">27</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">25</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">2</div></a></div><hr class="custom-hr"/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://raw.githubusercontent.com/C17zz/Pages/main/Img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20240709170801.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Chen's Blog"><span class="site-name">Chen's Blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">堆相关</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-08-08T08:54:40.000Z" title="Created 2024-08-08 16:54:40">2024-08-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-08-08T08:54:21.001Z" title="Updated 2024-08-08 16:54:21">2024-08-08</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Heap/">Heap</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="堆相关"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><em>仅供个人学习参考</em>  </p>
<span id="more"></span>

<p><img src="https://gateway.pinata.cloud/ipfs/bafkreibceromkvwouskhvxcvhbmiut75yhftpwm7xhty5j7ruwqbngfeuu" alt="0"></p>
<h2 id="堆块大小"><a href="#堆块大小" class="headerlink" title="堆块大小"></a>堆块大小</h2><p>chunk的大小(至少)都是8字节对齐，所以mchunk_ size的 低3位固定为0 (8D&#x3D; 1000B)。为了充分利用内存空间，mchunk_ size的低3位分别存储PREV_ INUS、IS_MMAPPED、NON_MAIN_ARENA信息。NON_MAIN_ARENA用来记录当前chunk是否不属于主线程，1表示不属于，0表示属于。IS_ MAPPED用来记录当前chunk是否是由mmap分配的。 PRE_INUSE用来记录前个chunk块是否被分配， 如果与当前chunk向 上相邻的chunk为被释放的状 态，则PREV_ INUSE标志位为0。</p>
<p>32位：<br>用户分配到的最小堆块是17B:  pre_size(4B) + size(4B) + fd(4B) + bk(4B) + pre_inuse (1B)<br>若用户申请的大小超过最小堆块大小，会与8B对齐（2<em>size_sz）<br>64位：<br>用户分配到的最小堆块是33B:  pre_size(8B) + size(8B) + fd(8B) + bk(8B) + pre_inuse (1B)<br>若用户申请的大小超过最小堆块大小，会与16B对齐（2</em>size_sz）</p>
<p><em>size_sz 32位为4B，64位为8B</em></p>
<h2 id="空间复用"><a href="#空间复用" class="headerlink" title="空间复用"></a>空间复用</h2><p>当一个chunk正在使用中，其下一个chunk的pre_size无效，可以被当前chunk使用</p>
<h2 id="ida中常见指针形式"><a href="#ida中常见指针形式" class="headerlink" title="ida中常见指针形式"></a>ida中常见指针形式</h2><p>*(point) &lt;&#x3D;&#x3D;&gt; [point]   伪代码&lt;&#x3D;&#x3D;&gt;汇编 </p>
<h2 id="堆申请内存本质"><a href="#堆申请内存本质" class="headerlink" title="堆申请内存本质"></a>堆申请内存本质</h2><p><img src="https://raw.githubusercontent.com/GNchen1/Pages/main/Img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-08-08%20102915.png" alt="1"></p>
<h2 id="free函数"><a href="#free函数" class="headerlink" title="free函数"></a>free函数</h2><p>调用free函数后程序做了两件事：<br>1.清空此堆块的user data<br>2.将指向此堆块的指针存储到main arena中（或是fast bin中）</p>
<h2 id="bin"><a href="#bin" class="headerlink" title="bin"></a>bin</h2><p>·与<strong>内存回收</strong>相关的概念，用户free掉的chunk并不是直接归还给操作系统，而是交由堆管理器（这里先谈ptmalloc）来管理，从而避免多次进行系统调用浪费大量资源<br>·ptmalloc将相似大小的chunk用双向链表连接起来，这样的一个链表被称为bin<br>·ptmalloc一共维护了128个bin，并使用一个数组来存储这些bin，如图<br><img src="https://raw.githubusercontent.com/GNchen1/Pages/main/Img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-08-08%20105000.png" alt="1"><br>·堆管理器根据特点，将bin分为四类： fast bin | unsorted bin | small bin | large bin<br>·数组中 bin1 为 unsorted bin；bin2<del>63 为small bin；bin64</del>126为large bin</p>
<h2 id="fast-bin"><a href="#fast-bin" class="headerlink" title="fast bin"></a>fast bin</h2><p>包含chunk大小：16B 24B … 80B<br>fast bin只使用了fd，为<strong>单链表</strong>结构<br>fast bin 不会主动进行合并<br>fastbinY为管理fast bin的数组，每个成员分别管理不同大小的fast bin<br>当用户申请大小小于或等于 fastbin_MAXSIZE时，优先从fast bin 中找，遵循<strong>LIFO</strong></p>
<h2 id="small-bin"><a href="#small-bin" class="headerlink" title="small bin"></a>small bin</h2><p>当用户申请大小大于 fastbin_MAXSIZE时，考虑small bin<br>small bin 为<strong>双链表</strong>结构，<strong>FIFO</strong><br>当满足small bin条件的chunk被free后，会优先放入unsorted bin，在一定情况下才会分配到small bin<br>相邻free chunk会合并</p>
<h2 id="unsorted-bin"><a href="#unsorted-bin" class="headerlink" title="unsorted bin"></a>unsorted bin</h2><p><strong>双链表</strong>结构，对chunk大小没有限制<br>当fast bin 和 small bin 中的chunk都不满足要求时，会优先考虑unsorted bin，它会在分配large bin之前对堆中的碎片chunk进行合并，以减少堆中的碎片</p>
<h2 id="top-chunk"><a href="#top-chunk" class="headerlink" title="top chunk"></a>top chunk</h2><p>程序第一次进行 malloc 的时候，heap 会被分为两块，一块给用户，剩下的那块就是 top chunk。其实，所谓的 top chunk 就是处于当前堆的物理地址最高的 chunk。这个 chunk 不属于任何一个 bin，它的作用在于当所有的 bin 都无法满足用户请求的大小时，如果其大小不小于指定的大小，就进行分配，并将剩下的部分作为新的 top chunk。否则，就对 heap 进行扩展后再进行分配。在 main arena 中通过 sbrk 扩展 heap，而在 thread arena 中通过 mmap 分配新的 heap。</p>
<p>需要注意的是，top chunk 的 prev_inuse 比特位始终为 1，否则其前面的 chunk 就会被合并到 top chunk 中。</p>
<p><em>初始情况下，我们可以将 unsorted chunk 作为 top chunk。</em></p>
<h2 id="last-remainder"><a href="#last-remainder" class="headerlink" title="last remainder"></a>last remainder</h2><p>在用户使用 malloc 请求分配内存时，ptmalloc2 找到的 chunk 可能并不和申请的内存大小一致，这时候就将分割之后的剩余部分称之为 last remainder chunk ，unsort bin 也会存这一块。top chunk 分割剩下的部分不会作为 last remainder</p>
<hr>
<p><strong>只有当真正访问一个地址的时候，系统才会建立虚拟页面与物理页面的映射关系</strong> ，故上面的内存分配的是虚拟内存</p>
<p><em>ptmalloc2主要通过malloc和free来分配和释放内存块</em></p>
<h2 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h2><p>在 glibc 的 malloc.c 中，malloc 的说明如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">  malloc(size_t n)</span><br><span class="line">  Returns a pointer to a newly allocated chunk of at least n bytes, or null</span><br><span class="line">  if no space is available. Additionally, on failure, errno is</span><br><span class="line">  set to ENOMEM on ANSI C systems.</span><br><span class="line">  If n is zero, malloc returns a minumum-sized chunk. (The minimum</span><br><span class="line">  size is 16 bytes on most 32bit systems, and 24 or 32 bytes on 64bit</span><br><span class="line">  systems.)  On most systems, size_t is an unsigned type, so calls</span><br><span class="line">  with negative arguments are interpreted as requests for huge amounts</span><br><span class="line">  of space, which will often fail. The maximum supported value of n</span><br><span class="line">  differs across systems, but is in all cases less than the maximum</span><br><span class="line">  representable value of a size_t.</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>

<p>可以看到malloc返回对应大小的指针，同时对一些异常情况做了处理<br>1.n&#x3D;0时，返回当前系统允许的最小内存块<br>2.n＜0时，由于n为无符号整数，此时会申请一个很大的内存块，而一般没有这么大内存块可申请，会报错</p>
<h2 id="free"><a href="#free" class="headerlink" title="free"></a>free</h2><p>在 glibc 的 malloc.c 中，free 的说明如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">    free(void* p)</span><br><span class="line">    Releases the chunk of memory pointed to by p, that had been previously</span><br><span class="line">    allocated using malloc or a related routine such as realloc.</span><br><span class="line">    It has no effect if p is null. It can have arbitrary (i.e., bad!)</span><br><span class="line">    effects if p has already been freed.</span><br><span class="line">    Unless disabled (using mallopt), freeing very large spaces will</span><br><span class="line">    when possible, automatically trigger operations that give</span><br><span class="line">    back unused memory to the system, thus reducing program footprint.</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<p>可以看出,free 函数会释放由 p 所指向的内存块。这个内存块有可能是通过 malloc 函数得到的，也有可能是通过相关的函数 realloc 得到的。<br>同样对一些异常情况做了处理<br>1.当 p 为空指针时，函数不执行任何操作。<br>2.当 p 已经被释放之后，再次释放会出现乱七八糟的效果，这其实就是 double free。<br>除了被禁用 (mallopt) 的情况下，当释放很大的内存空间时，程序会将这些内存空间还给系统，以便于减小程序所使用的内存空间。</p>
<h2 id="内存分配背后的系统调用"><a href="#内存分配背后的系统调用" class="headerlink" title="内存分配背后的系统调用"></a>内存分配背后的系统调用</h2><p>操作系统提供brk，glibc库提供sbrk，我们可以通过增加 brk 的大小来向操作系统申请内存。<br>初始时，堆的起始地址 start_brk 以及堆的当前末尾 brk 指向同一地址。根据是否开启 ASLR，两者的具体位置会有所不同<br>1.不开启 ASLR 保护时，start_brk 以及 brk 会指向 data&#x2F;bss 段的结尾。<br>2.开启 ASLR 保护时，start_brk 以及 brk 也会指向同一位置，只是这个位置是在 data&#x2F;bss 段结尾后的随机偏移处</p>
<p>malloc 会使用 mmap 来创建独立的匿名映射段。匿名映射的目的主要是可以申请以 0 填充的内存，并且这块内存仅被调用进程所使用</p>
<h2 id="多线程支持"><a href="#多线程支持" class="headerlink" title="多线程支持"></a>多线程支持</h2><p>在原来的 dlmalloc 实现中，当两个线程同时要申请内存时，只有一个线程可以进入临界区申请内存，而另外一个线程则必须等待直到临界区中不再有线程。这是因为所有的线程共享一个堆。在 glibc 的 ptmalloc 实现中，比较好的一点就是支持了多线程的快速访问。在新的实现中，所有的线程共享多个堆。</p>
<h2 id="arena"><a href="#arena" class="headerlink" title="arena"></a>arena</h2><p>虽然程序可能只是向操作系统申请很小的内存，但是为了方便，操作系统会把很大的内存分配给程序。我们称这一块连续的内存区域为 arena。此外，我们称由主线程申请的内存为 <strong>main_arena</strong>。后续的申请的内存会一直从这个 arena 中获取，直到空间不足。当 arena 空间不足时，它可以通过增加 brk 的方式来增加堆的空间。类似地，arena 也可以通过减小 brk 来缩小自己的空间。</p>
<p>在主线程释放内存后，其对应的 arena 并没有进行回收，而是交由 glibc 来进行管理。当后面程序再次申请内存时，在 glibc 中管理的内存充足的情况下，glibc 就会根据堆分配的算法来给程序分配相应的内存。</p>
<h2 id="brk-sbrk函数-（摘自评论区-作者：载酒）"><a href="#brk-sbrk函数-（摘自评论区-作者：载酒）" class="headerlink" title="brk&amp;sbrk函数 （摘自评论区 作者：载酒）"></a>brk&amp;sbrk函数 （摘自评论区 作者：载酒）</h2><p>【定义】<br>对于堆的操作，操作系统提供了 brk 函数，glibc 库提供了 sbrk 函数，brk是系统调用 而sbrk不是  ，sbrk调用了brk<br>内核维护一个进程控制块（PCB），该结构体中维护两个指针：start_brk和brk，他们分别表示堆块的开始地址和结束地址<br>【函数使用】<br>sbrk函数<br>定义：传参0时可以获取当前brk指针的值，传参num时可以将当前brk指针的值增加拓展num字节(传参整数是增加，传参负数是减少)<br>返回值：若成功，brk()会返回0，否则返回-1。<br>brk函数<br>定义：可以改变brk指针内存储的地址（即堆结束地址，又叫堆顶），传参多少就把brk设置为多少<br>返回值：若成功，brk()会返回0，否则返回-1。<br>示例<br>同样是将堆地址拓展4096字节，有以下两种写法<br>● 1、使用sbrk函数进行拓展</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">void</span> original_brk = (<span class="type">void</span>*)sbrk(<span class="number">0</span>); <span class="comment">//获取当前堆顶地址</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Original break: %p\n&quot;</span>,original_brk);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(sbrk(<span class="number">4096</span>) != (<span class="type">void</span>*)<span class="number">-1</span>)&#123; <span class="comment">//扩展堆顶地址4096字节</span></span><br><span class="line">        <span class="type">void</span>* updated_brk = (<span class="type">void</span>*)sbrk(<span class="number">0</span>); <span class="comment">//获取更新过后的堆顶地址</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;updated break: %p\n&quot;</span>,updated_brk);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to update break\n&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、使用brk函数进行拓展</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">void</span> new_brk = (<span class="type">void</span>*)sbrk(<span class="number">0</span>); <span class="comment">//获取当前堆顶地址</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Original break: %p\n&quot;</span>,new_brk);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(brk(new_brk+<span class="number">4096</span>)==<span class="number">0</span>)&#123; <span class="comment">//扩展堆顶地址4096字节</span></span><br><span class="line">        <span class="type">void</span>* updated_brk = (<span class="type">void</span>*)sbrk(<span class="number">0</span>); <span class="comment">//获取更新过后的堆顶地址</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;updated break: %p\n&quot;</span>,updated_brk);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to update break\n&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://example.com">GNchen1</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://example.com/2024/08/08/%E5%A0%86%E7%9B%B8%E5%85%B3/">http://example.com/2024/08/08/%E5%A0%86%E7%9B%B8%E5%85%B3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%A0%86/">堆</a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/C17zz/Pages/main/Img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20240709170801.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/08/13/%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA/" title="整数溢出"><img class="cover" src="https://raw.githubusercontent.com/C17zz/Pages/main/Img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20240709170801.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">整数溢出</div></div></a></div><div class="next-post pull-right"><a href="/2024/08/05/%E6%A0%88%E4%B8%8A%E7%9A%84partial%20overwrite%EF%BC%88%E7%BB%95%E8%BF%87pie%EF%BC%89/" title="栈上的partial overwrite（绕过pie）"><img class="cover" src="https://raw.githubusercontent.com/C17zz/Pages/main/Img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20240709170801.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next</div><div class="next_info">栈上的partial overwrite（绕过pie）</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://raw.githubusercontent.com/C17zz/Pages/main/Img/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20240709170756.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">GNchen1</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">27</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">25</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">2</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/GNchen1"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">每个灵魂里都有一朵玫瑰</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A0%86%E5%9D%97%E5%A4%A7%E5%B0%8F"><span class="toc-number">1.</span> <span class="toc-text">堆块大小</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A9%BA%E9%97%B4%E5%A4%8D%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">空间复用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ida%E4%B8%AD%E5%B8%B8%E8%A7%81%E6%8C%87%E9%92%88%E5%BD%A2%E5%BC%8F"><span class="toc-number">3.</span> <span class="toc-text">ida中常见指针形式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A0%86%E7%94%B3%E8%AF%B7%E5%86%85%E5%AD%98%E6%9C%AC%E8%B4%A8"><span class="toc-number">4.</span> <span class="toc-text">堆申请内存本质</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#free%E5%87%BD%E6%95%B0"><span class="toc-number">5.</span> <span class="toc-text">free函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bin"><span class="toc-number">6.</span> <span class="toc-text">bin</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fast-bin"><span class="toc-number">7.</span> <span class="toc-text">fast bin</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#small-bin"><span class="toc-number">8.</span> <span class="toc-text">small bin</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#unsorted-bin"><span class="toc-number">9.</span> <span class="toc-text">unsorted bin</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#top-chunk"><span class="toc-number">10.</span> <span class="toc-text">top chunk</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#last-remainder"><span class="toc-number">11.</span> <span class="toc-text">last remainder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#malloc"><span class="toc-number">12.</span> <span class="toc-text">malloc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#free"><span class="toc-number">13.</span> <span class="toc-text">free</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E8%83%8C%E5%90%8E%E7%9A%84%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">14.</span> <span class="toc-text">内存分配背后的系统调用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%94%AF%E6%8C%81"><span class="toc-number">15.</span> <span class="toc-text">多线程支持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#arena"><span class="toc-number">16.</span> <span class="toc-text">arena</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#brk-sbrk%E5%87%BD%E6%95%B0-%EF%BC%88%E6%91%98%E8%87%AA%E8%AF%84%E8%AE%BA%E5%8C%BA-%E4%BD%9C%E8%80%85%EF%BC%9A%E8%BD%BD%E9%85%92%EF%BC%89"><span class="toc-number">17.</span> <span class="toc-text">brk&amp;sbrk函数 （摘自评论区 作者：载酒）</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/16/Ubuntu%2016.04%20%E4%B8%8B%E5%AE%89%E8%A3%85VMware%20Tools/" title="Ubuntu 16.04 下安装VMware Tools">Ubuntu 16.04 下安装VMware Tools</a><time datetime="2024-08-16T03:42:04.000Z" title="Created 2024-08-16 11:42:04">2024-08-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/15/%E4%BD%BF%E7%94%A8echo%E5%91%BD%E4%BB%A4%E8%BE%93%E5%87%BAflag/" title="使用echo命令输出flag">使用echo命令输出flag</a><time datetime="2024-08-15T02:35:04.000Z" title="Created 2024-08-15 10:35:04">2024-08-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/13/%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA/" title="整数溢出">整数溢出</a><time datetime="2024-08-13T08:28:20.000Z" title="Created 2024-08-13 16:28:20">2024-08-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/08/%E5%A0%86%E7%9B%B8%E5%85%B3/" title="堆相关">堆相关</a><time datetime="2024-08-08T08:54:40.000Z" title="Created 2024-08-08 16:54:40">2024-08-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/05/%E6%A0%88%E4%B8%8A%E7%9A%84partial%20overwrite%EF%BC%88%E7%BB%95%E8%BF%87pie%EF%BC%89/" title="栈上的partial overwrite（绕过pie）">栈上的partial overwrite（绕过pie）</a><time datetime="2024-08-05T11:10:04.000Z" title="Created 2024-08-05 19:10:04">2024-08-05</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By GNchen1</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="/js/tw_cn.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>